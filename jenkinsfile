pipeline {
    agent any
    
    environment {
        // Project configuration
        PROJECT_DIR = '/home/devops/mini-projet-'
        TOMCAT_URL = 'http://192.168.100.130:8080'
        SONAR_HOST = 'http://192.168.100.130:9000'
        MAVEN_OPTS = '-Xmx512m'
    }
    
    tools {
        maven 'Maven3'
        jdk 'JDK11'
    }
    
    stages {
        stage('1Ô∏è‚É£ Preparation') {
            steps {
                echo '=========================================='
                echo 'üì¶ Stage 1: Preparation'
                echo '=========================================='
                script {
                    sh """
                        echo "Project Directory: ${PROJECT_DIR}"
                        echo "Tomcat URL: ${TOMCAT_URL}"
                        echo "SonarQube: ${SONAR_HOST}"
                        echo ""
                        
                        # V√©rifier projet existe
                        if [ ! -d "${PROJECT_DIR}" ]; then
                            echo "‚ùå Project not found: ${PROJECT_DIR}"
                            exit 1
                        fi
                        
                        echo "‚úÖ Project directory exists"
                        ls -la ${PROJECT_DIR}
                    """
                }
            }
        }
        
        stage('2Ô∏è‚É£ Maven Build') {
            steps {
                echo '=========================================='
                echo 'üî® Stage 2: Maven Build'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Starting Maven build..."
                        mvn clean compile
                        echo "‚úÖ Build completed!"
                    '''
                }
            }
        }
        
        stage('3Ô∏è‚É£ Unit Tests') {
            steps {
                echo '=========================================='
                echo 'üß™ Stage 3: Unit Tests'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Running unit tests..."
                        mvn test || true
                        echo "‚úÖ Tests completed!"
                    '''
                }
            }
            post {
                always {
                    dir("${PROJECT_DIR}") {
                        junit '**/target/surefire-reports/*.xml' allowEmptyResults: true
                    }
                }
            }
        }
        
        stage('4Ô∏è‚É£ SAST - SonarQube Analysis') {
            steps {
                echo '=========================================='
                echo 'üîç Stage 4: SAST Analysis'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    script {
                        try {
                            withSonarQubeEnv('SonarQube') {
                                sh """
                                    echo "Running SonarQube analysis..."
                                    mvn sonar:sonar \
                                        -Dsonar.projectKey=mini-projet \
                                        -Dsonar.projectName=mini-projet \
                                        -Dsonar.host.url=${SONAR_HOST}
                                    echo "‚úÖ SonarQube analysis completed!"
                                """
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è SonarQube analysis failed: ${e.getMessage()}"
                            echo "Pipeline will continue..."
                        }
                    }
                }
            }
        }
        
        stage('5Ô∏è‚É£ Quality Gate') {
            steps {
                echo '=========================================='
                echo 'üìä Stage 5: Quality Gate Check'
                echo '=========================================='
                script {
                    try {
                        timeout(time: 3, unit: 'MINUTES') {
                            echo "Waiting for Quality Gate result..."
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate status: ${qg.status}"
                            } else {
                                echo "‚úÖ Quality Gate passed!"
                            }
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Quality Gate check failed: ${e.getMessage()}"
                        echo "Pipeline will continue..."
                    }
                }
            }
        }
        
        stage('6Ô∏è‚É£ Package WAR') {
            steps {
                echo '=========================================='
                echo 'üì¶ Stage 6: Package Application'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Creating WAR package..."
                        mvn package -DskipTests
                        
                        echo ""
                        echo "Generated artifacts:"
                        ls -lh target/*.war
                        echo ""
                        echo "‚úÖ WAR package created!"
                    '''
                }
            }
            post {
                success {
                    dir("${PROJECT_DIR}") {
                        archiveArtifacts artifacts: '**/target/*.war', fingerprint: true, allowEmptyArchive: true
                    }
                }
            }
        }
        
        stage('7Ô∏è‚É£ Deploy to Tomcat') {
            steps {
                echo '=========================================='
                echo 'üöÄ Stage 7: Deploy to Tomcat'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        echo "Deploying WAR to Tomcat..."
                        
                        # Copier WAR vers Tomcat
                        sudo cp target/*.war /var/lib/tomcat9/webapps/mini-projet.war
                        
                        # V√©rifier copie
                        echo ""
                        echo "Deployed WAR file:"
                        ls -lh /var/lib/tomcat9/webapps/mini-projet.war
                        
                        echo ""
                        echo "‚úÖ Deployment completed!"
                    '''
                }
            }
        }
        
        stage('8Ô∏è‚É£ Wait for Application') {
            steps {
                echo '=========================================='
                echo '‚è≥ Stage 8: Wait for Application Startup'
                echo '=========================================='
                script {
                    echo "Waiting 30 seconds for Tomcat to deploy application..."
                    sleep(time: 30, unit: 'SECONDS')
                    
                    echo ""
                    echo "Checking application availability..."
                    
                    def maxRetries = 10
                    def retryCount = 0
                    def isReady = false
                    
                    while (retryCount < maxRetries && !isReady) {
                        try {
                            def response = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' ${TOMCAT_URL}",
                                returnStdout: true
                            ).trim()
                            
                            echo "Attempt ${retryCount + 1}/${maxRetries}: HTTP ${response}"
                            
                            if (response == '200') {
                                echo "‚úÖ Application is ready!"
                                isReady = true
                            } else {
                                echo "‚è≥ Application starting... waiting 5s"
                                sleep(time: 5, unit: 'SECONDS')
                                retryCount++
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Connection failed, retrying..."
                            sleep(time: 5, unit: 'SECONDS')
                            retryCount++
                        }
                    }
                    
                    if (!isReady) {
                        echo "‚ö†Ô∏è Application may not be fully ready"
                        echo "Continuing with DAST scan anyway..."
                    }
                }
            }
        }
        
        stage('9Ô∏è‚É£ DAST - Nikto Security Scan') {
            steps {
                echo '=========================================='
                echo 'üîç Stage 9: DAST Security Scan'
                echo '=========================================='
                script {
                    def timestamp = sh(
                        script: "date +%Y%m%d-%H%M%S",
                        returnStdout: true
                    ).trim()
                    
                    sh """
                        echo "======================================"
                        echo "üîí DAST Security Scan with Nikto"
                        echo "======================================"
                        echo ""
                        echo "Target URL: ${TOMCAT_URL}"
                        echo "Timestamp: ${timestamp}"
                        echo ""
                        
                        # Cr√©er dossier rapports
                        mkdir -p ${WORKSPACE}/dast-reports
                        
                        # V√©rifier application accessible
                        echo "üì° Testing application accessibility..."
                        HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" ${TOMCAT_URL} 2>/dev/null || echo "000")
                        echo "HTTP Status: \$HTTP_CODE"
                        echo ""
                        
                        if [ "\$HTTP_CODE" != "200" ]; then
                            echo "‚ö†Ô∏è Warning: Application returned HTTP \$HTTP_CODE"
                            echo "Scan will proceed but results may be incomplete."
                            echo ""
                        fi
                        
                        # Lancer Nikto scan
                        echo "üîç Starting Nikto security scan..."
                        echo "This may take 5-15 minutes depending on application size..."
                        echo ""
                        
                        nikto -h ${TOMCAT_URL} \
                              -o ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.html \
                              -Format html \
                              -Tuning 123456789abc \
                              -Display V \
                              -timeout 10 || true
                        
                        echo ""
                        echo "Generating text report for analysis..."
                        nikto -h ${TOMCAT_URL} \
                              -o ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt \
                              -Format txt \
                              -Tuning 123456789abc \
                              -Display 1 \
                              -timeout 10 || true
                        
                        echo ""
                        echo "======================================"
                        echo "üìä DAST Scan Results Analysis"
                        echo "======================================"
                        echo ""
                        
                        # Analyser r√©sultats
                        if [ -f "${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt" ]; then
                            # Compter alertes
                            ALERT_COUNT=\$(grep -c "+" ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt 2>/dev/null || echo "0")
                            echo "üìà Total alerts found: \$ALERT_COUNT"
                            
                            # Afficher top alertes
                            echo ""
                            echo "üî¥ Top Security Findings:"
                            echo "---"
                            grep "+" ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt 2>/dev/null | head -10 || echo "No major alerts found"
                            
                            # Rechercher vuln√©rabilit√©s critiques
                            echo ""
                            echo "üîí Critical Vulnerabilities Check:"
                            echo "---"
                            
                            OSVDB_COUNT=\$(grep -c "OSVDB" ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt 2>/dev/null || echo "0")
                            echo "OSVDB entries found: \$OSVDB_COUNT"
                            
                            HTTP_METHODS=\$(grep -i "allowed http methods" ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt 2>/dev/null || echo "Not detected")
                            echo "HTTP Methods: \$HTTP_METHODS"
                            
                            HEADERS=\$(grep -i "header" ${WORKSPACE}/dast-reports/nikto-report-${timestamp}.txt 2>/dev/null | wc -l || echo "0")
                            echo "Security headers issues: \$HEADERS"
                        else
                            echo "‚ö†Ô∏è Text report not generated successfully"
                        fi
                        
                        echo ""
                        echo "======================================"
                        echo "‚úÖ DAST Scan Completed!"
                        echo "======================================"
                        echo ""
                        echo "üìÅ Reports generated:"
                        ls -lh ${WORKSPACE}/dast-reports/ | grep nikto-report-${timestamp}
                        echo ""
                        echo "üìÑ View HTML report in Jenkins:"
                        echo "   Build ‚Üí DAST Security Report"
                        echo ""
                        echo "======================================"
                    """
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'dast-reports',
                        reportFiles: 'nikto-report-*.html',
                        reportName: 'DAST Security Report',
                        reportTitles: 'Nikto DAST Scan Results'
                    ])
                }
            }
        }
        
        stage('üîü Final Health Check') {
            steps {
                echo '=========================================='
                echo 'üè• Stage 10: Final Health Check'
                echo '=========================================='
                script {
                    sh """
                        echo "======================================"
                        echo "üè• Application Health Check"
                        echo "======================================"
                        echo ""
                        echo "Base URL: ${TOMCAT_URL}"
                        echo ""
                        echo "Testing common endpoints..."
                        echo ""
                        
                        # Tester endpoints principaux
                        for page in index.html login.html signup.html contact.html about.html services.html; do
                            HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" ${TOMCAT_URL}/\$page 2>/dev/null || echo "000")
                            if [ "\$HTTP_CODE" = "200" ]; then
                                echo "‚úÖ \$page - OK (HTTP \$HTTP_CODE)"
                            elif [ "\$HTTP_CODE" = "404" ]; then
                                echo "‚ö†Ô∏è \$page - Not Found (HTTP \$HTTP_CODE)"
                            else
                                echo "‚ùå \$page - Error (HTTP \$HTTP_CODE)"
                            fi
                        done
                        
                        echo ""
                        echo "======================================"
                        echo "‚úÖ Health Check Completed!"
                        echo "======================================"
                    """
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo '=========================================='
                echo '‚úÖ PIPELINE COMPLETED SUCCESSFULLY! üéâ'
                echo '=========================================='
                echo ''
                echo 'üìã Pipeline Summary:'
                echo '---'
                echo '‚úÖ Build: Success'
                echo '‚úÖ Tests: Completed'
                echo '‚úÖ SAST: Analyzed'
                echo '‚úÖ Deploy: Success'
                echo '‚úÖ DAST: Scanned'
                echo ''
                echo 'üåê Application URL:'
                echo "   ${TOMCAT_URL}"
                echo ''
                echo 'üìä Reports Available:'
                echo "   - SonarQube SAST: ${SONAR_HOST}"
                echo '   - DAST Security: Check Build Artifacts'
                echo ''
                echo 'üéØ Next Steps:'
                echo '   1. Review DAST security findings'
                echo '   2. Check SonarQube quality metrics'
                echo '   3. Test application functionality'
                echo '   4. Fix identified vulnerabilities'
                echo ''
                echo '=========================================='
            }
        }
        failure {
            script {
                echo '=========================================='
                echo '‚ùå PIPELINE FAILED!'
                echo '=========================================='
                echo ''
                echo 'üîç Troubleshooting Steps:'
                echo '---'
                echo '1. Check console output for error details'
                echo '2. Verify all services are running:'
                echo '   - Jenkins: sudo systemctl status jenkins'
                echo '   - Tomcat: sudo systemctl status tomcat9'
                echo '   - SonarQube: sudo systemctl status sonarqube'
                echo '3. Check application build:'
                echo '   - Maven compilation errors?'
                echo '   - Test failures?'
                echo '   - Missing dependencies?'
                echo '4. Verify deployment:'
                echo '   - WAR file created?'
                echo '   - Permissions correct?'
                echo '   - Tomcat webapps writable?'
                echo ''
                echo 'üìß Common Issues:'
                echo '   - Network connectivity problems'
                echo '   - Insufficient disk space'
                echo '   - Permission denied errors'
                echo '   - Service not responding'
                echo ''
                echo '=========================================='
            }
        }
        always {
            script {
                echo ''
                echo 'üßπ Cleanup: Workspace preserved for debugging'
                echo "üìÅ Workspace: ${WORKSPACE}"
                echo "‚è∞ Build Duration: ${currentBuild.durationString}"
                echo ''
            }
        }
    }
}
