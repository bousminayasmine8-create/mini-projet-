pipeline {
    agent any
    
    environment {
        MAVEN_HOME = "/usr/share/maven"
        JAVA_HOME  = "/usr/lib/jvm/java-17-openjdk-amd64"
        PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${env.PATH}"
        
        // Configuration Tomcat
        TOMCAT_URL = "http://localhost:8080"
        APP_NAME = "mini-projet"  // On d√©ploie avec un nom simple
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                git branch: 'main', 
                    url: 'https://github.com/bousminayasmine8-create/mini-projet-.git',
                    credentialsId: 'gitjinkins'
            }
        }
        
        stage('Build') {
            steps {
                echo 'üî® Compilation du projet...'
                sh 'mvn clean compile'
            }
        }
        
        stage('Unit Tests') {
            steps {
                echo 'üß™ Ex√©cution des tests unitaires...'
                sh 'mvn test || true'
            }
            post {
                always {
                    junit testResults: '**/target/surefire-reports/*.xml', 
                         allowEmptyResults: true
                }
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                echo 'üîç Analyse SonarQube...'
                script {
                    try {
                        timeout(time: 30, unit: 'SECONDS') {
                            sh 'curl -f http://localhost:9000/api/system/status'
                            echo '‚úÖ SonarQube accessible !'
                            
                            withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
                                timeout(time: 5, unit: 'MINUTES') {
                                    sh """
                                        mvn sonar:sonar \
                                        -Dsonar.projectKey=mini-projet \
                                        -Dsonar.host.url=http://localhost:9000 \
                                        -Dsonar.login=\${SONAR_TOKEN}
                                    """
                                }
                            }
                            echo '‚úÖ Analyse SonarQube termin√©e !'
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è SonarQube ignor√©: ${e.message}"
                        echo "‚è≠Ô∏è Suite du pipeline..."
                    }
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'üì¶ Cr√©ation du fichier WAR...'
                sh 'mvn package -DskipTests'
            }
            post {
                success {
                    archiveArtifacts artifacts: '**/target/*.war', 
                                   fingerprint: true
                    script {
                        def warFile = sh(
                            script: "find target -name '*.war' | head -1", 
                            returnStdout: true
                        ).trim()
                        echo "‚úÖ Fichier WAR cr√©√©: ${warFile}"
                    }
                }
            }
        }
        
        stage('Stop Old Application') {
            steps {
                echo 'üõë Arr√™t de l\'ancienne version...'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'tomcat-credentials', 
                        usernameVariable: 'TOMCAT_USER', 
                        passwordVariable: 'TOMCAT_PASS'
                    )]) {
                        // Undeploy les anciennes versions
                        sh """
                            # Undeploy avec le nom simple
                            curl -s --user \${TOMCAT_USER}:\${TOMCAT_PASS} \
                            "${TOMCAT_URL}/manager/text/undeploy?path=/${APP_NAME}" || true
                            
                            # Undeploy avec la version (au cas o√π)
                            curl -s --user \${TOMCAT_USER}:\${TOMCAT_PASS} \
                            "${TOMCAT_URL}/manager/text/undeploy?path=/mini-projet-1.0.0-SNAPSHOT" || true
                        """
                        echo '‚úÖ Anciennes versions supprim√©es'
                    }
                }
            }
        }
        
        stage('Deploy to Tomcat') {
            steps {
                echo 'üöÄ D√©ploiement sur Tomcat...'
                script {
                    def warFile = sh(
                        script: "find target -name '*.war' | head -1", 
                        returnStdout: true
                    ).trim()
                    
                    echo "üì¶ D√©ploiement de: ${warFile}"
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'tomcat-credentials', 
                        usernameVariable: 'TOMCAT_USER', 
                        passwordVariable: 'TOMCAT_PASS'
                    )]) {
                        def response = sh(
                            script: """
                                curl -s --upload-file ${warFile} \
                                --user \${TOMCAT_USER}:\${TOMCAT_PASS} \
                                "${TOMCAT_URL}/manager/text/deploy?path=/${APP_NAME}&update=true"
                            """,
                            returnStdout: true
                        ).trim()
                        
                        echo "üìã R√©ponse Tomcat: ${response}"
                        
                        if (response.contains('OK')) {
                            echo '‚úÖ D√©ploiement r√©ussi !'
                        } else {
                            echo "‚ö†Ô∏è R√©ponse: ${response}"
                        }
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'üîç V√©rification du d√©ploiement...'
                script {
                    echo '‚è≥ Attente du d√©marrage de l\'application (10 secondes)...'
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // Test de l'application
                    def statusCode = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' ${TOMCAT_URL}/${APP_NAME}/",
                        returnStdout: true
                    ).trim()
                    
                    echo "üìä Code HTTP: ${statusCode}"
                    
                    if (statusCode == '200' || statusCode == '302' || statusCode == '303') {
                        echo '‚úÖ Application accessible et fonctionnelle !'
                    } else {
                        echo "‚ö†Ô∏è L'application retourne le code HTTP ${statusCode}"
                        echo "üí° V√©rifiez manuellement: ${TOMCAT_URL}/${APP_NAME}/"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo ''
            echo 'üéâ ================================================'
            echo 'üéâ       D√âPLOIEMENT R√âUSSI !'
            echo 'üéâ ================================================'
            echo ''
            echo 'üåê Votre application est accessible sur:'
            echo "   ${TOMCAT_URL}/${APP_NAME}/"
            echo "   ${TOMCAT_URL}/${APP_NAME}/about.html"
            echo ''
            echo 'üìä Autres liens utiles:'
            echo "   - SonarQube: http://localhost:9000/dashboard?id=mini-projet"
            echo "   - Tomcat Manager: ${TOMCAT_URL}/manager/html"
            echo "   - Jenkins: http://192.168.100.130:8081/job/projet/"
            echo ''
            echo 'üéâ ================================================'
        }
        failure {
            echo ''
            echo '‚ùå ================================================'
            echo '‚ùå         √âCHEC DU D√âPLOIEMENT'
            echo '‚ùå ================================================'
            echo ''
            echo 'üîç V√©rifications √† faire:'
            echo '   1. Tomcat fonctionne: sudo systemctl status tomcat'
            echo '   2. Logs Tomcat: sudo tail -f /opt/tomcat/logs/catalina.out'
            echo "   3. Manager: ${TOMCAT_URL}/manager/html"
            echo "   4. Credentials Jenkins: 'tomcat-credentials'"
            echo ''
        }
        always {
            echo ''
            echo 'üìä Informations du build:'
            echo "   - Build #${BUILD_NUMBER}"
            echo "   - Workspace: ${WORKSPACE}"
        }
    }
}
