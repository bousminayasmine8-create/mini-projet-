pipeline {
    agent any
    
    environment {
        PROJECT_DIR = '/home/devops/mini-projet-'
        TOMCAT_URL = 'http://192.168.100.130:8080'
        SONAR_HOST = 'http://192.168.100.130:9000'
    }
    
    stages {
        stage('1Ô∏è‚É£ Preparation') {
            steps {
                echo '=========================================='
                echo 'üì¶ Preparation'
                echo '=========================================='
                sh """
                    echo "Project: ${PROJECT_DIR}"
                    echo "Tomcat: ${TOMCAT_URL}"
                    ls -la ${PROJECT_DIR}
                """
            }
        }
        
        stage('2Ô∏è‚É£ Build') {
            steps {
                echo '=========================================='
                echo 'üî® Maven Build'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh 'mvn clean compile'
                }
            }
        }
        
        stage('3Ô∏è‚É£ Tests') {
            steps {
                echo '=========================================='
                echo 'üß™ Unit Tests'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh 'mvn test || true'
                }
            }
            post {
                always {
                    dir("${PROJECT_DIR}") {
                        junit '**/target/surefire-reports/*.xml' allowEmptyResults: true
                    }
                }
            }
        }
        
        stage('4Ô∏è‚É£ SAST') {
            steps {
                echo '=========================================='
                echo 'üîç SonarQube Analysis'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    script {
                        try {
                            withSonarQubeEnv('SonarQube') {
                                sh """
                                    mvn sonar:sonar \
                                        -Dsonar.projectKey=mini-projet \
                                        -Dsonar.host.url=${SONAR_HOST}
                                """
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è SAST failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
        
        stage('5Ô∏è‚É£ Quality Gate') {
            steps {
                echo '=========================================='
                echo 'üìä Quality Gate'
                echo '=========================================='
                script {
                    try {
                        timeout(time: 3, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Quality Gate timeout"
                    }
                }
            }
        }
        
        stage('6Ô∏è‚É£ Package') {
            steps {
                echo '=========================================='
                echo 'üì¶ Package WAR'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn package -DskipTests
                        ls -lh target/*.war
                    '''
                }
            }
            post {
                success {
                    dir("${PROJECT_DIR}") {
                        archiveArtifacts artifacts: '**/target/*.war', allowEmptyArchive: true
                    }
                }
            }
        }
        
        stage('7Ô∏è‚É£ Deploy') {
            steps {
                echo '=========================================='
                echo 'üöÄ Deploy to Tomcat'
                echo '=========================================='
                dir("${PROJECT_DIR}") {
                    sh '''
                        sudo cp target/*.war /var/lib/tomcat9/webapps/mini-projet.war
                        ls -lh /var/lib/tomcat9/webapps/mini-projet.war
                    '''
                }
                sleep(time: 30, unit: 'SECONDS')
            }
        }
        
        stage('8Ô∏è‚É£ Wait App') {
            steps {
                echo '=========================================='
                echo '‚è≥ Waiting for Application'
                echo '=========================================='
                script {
                    def maxRetries = 10
                    def retryCount = 0
                    def ready = false
                    
                    while (retryCount < maxRetries && !ready) {
                        try {
                            def response = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' ${TOMCAT_URL}",
                                returnStdout: true
                            ).trim()
                            
                            if (response == '200') {
                                echo "‚úÖ App ready!"
                                ready = true
                            } else {
                                echo "‚è≥ Waiting... (${retryCount + 1}/${maxRetries})"
                                sleep(5)
                                retryCount++
                            }
                        } catch (Exception e) {
                            sleep(5)
                            retryCount++
                        }
                    }
                }
            }
        }
        
        stage('9Ô∏è‚É£ DAST') {
            steps {
                echo '=========================================='
                echo 'üîí DAST Security Scan'
                echo '=========================================='
                script {
                    def timestamp = sh(
                        script: "date +%Y%m%d-%H%M%S",
                        returnStdout: true
                    ).trim()
                    
                    sh """
                        mkdir -p \${WORKSPACE}/dast-reports
                        
                        echo "üîç DAST with Nikto"
                        echo "Target: ${TOMCAT_URL}"
                        echo "Report: nikto-${timestamp}.html"
                        echo ""
                        
                        # Check app
                        HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" ${TOMCAT_URL})
                        echo "App status: HTTP \$HTTP_CODE"
                        echo ""
                        
                        # Scan
                        echo "Starting scan..."
                        nikto -h ${TOMCAT_URL} \
                              -o \${WORKSPACE}/dast-reports/nikto-${timestamp}.html \
                              -Format html \
                              -Tuning 123456789abc \
                              -Display V || true
                        
                        nikto -h ${TOMCAT_URL} \
                              -o \${WORKSPACE}/dast-reports/nikto-${timestamp}.txt \
                              -Format txt \
                              -Tuning 123456789abc || true
                        
                        echo ""
                        echo "üìä Analysis:"
                        if [ -f \${WORKSPACE}/dast-reports/nikto-${timestamp}.txt ]; then
                            ALERTS=\$(grep -c "+" \${WORKSPACE}/dast-reports/nikto-${timestamp}.txt || echo "0")
                            echo "Total alerts: \$ALERTS"
                            
                            OSVDB=\$(grep -c "OSVDB" \${WORKSPACE}/dast-reports/nikto-${timestamp}.txt || echo "0")
                            echo "OSVDB entries: \$OSVDB"
                            
                            echo ""
                            echo "Top findings:"
                            grep "+" \${WORKSPACE}/dast-reports/nikto-${timestamp}.txt | head -10 || true
                        fi
                        
                        echo ""
                        echo "‚úÖ DAST completed!"
                        ls -lh \${WORKSPACE}/dast-reports/
                    """
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'dast-reports',
                        reportFiles: 'nikto-*.html',
                        reportName: 'DAST Security Report'
                    ])
                }
            }
        }
        
        stage('üîü Health Check') {
            steps {
                echo '=========================================='
                echo 'üè• Final Health Check'
                echo '=========================================='
                sh """
                    echo "Testing endpoints:"
                    for page in index.html login.html signup.html contact.html; do
                        CODE=\$(curl -s -o /dev/null -w "%{http_code}" ${TOMCAT_URL}/\$page || echo "000")
                        if [ "\$CODE" = "200" ]; then
                            echo "‚úÖ \$page (HTTP \$CODE)"
                        else
                            echo "‚ö†Ô∏è \$page (HTTP \$CODE)"
                        fi
                    done
                """
            }
        }
    }
    
    post {
        success {
            echo '=========================================='
            echo '‚úÖ PIPELINE SUCCESS! üéâ'
            echo '=========================================='
            echo ''
            echo 'üìã Summary:'
            echo '  ‚úÖ Build: OK'
            echo '  ‚úÖ Tests: OK'
            echo '  ‚úÖ SAST: OK'
            echo '  ‚úÖ Deploy: OK'
            echo '  ‚úÖ DAST: OK'
            echo ''
            echo 'üåê App: ${TOMCAT_URL}'
            echo 'üìä SonarQube: ${SONAR_HOST}'
            echo 'üîí DAST: Check Build Artifacts'
            echo ''
            echo '=========================================='
        }
        failure {
            echo '=========================================='
            echo '‚ùå PIPELINE FAILED!'
            echo '=========================================='
            echo ''
            echo 'Check console output for errors'
            echo ''
        }
    }
}
